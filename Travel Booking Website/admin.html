<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | HIKAYAT TRAVELS & TOURS</title>
    <link rel="stylesheet" href="styles.css">
    <script defer src="js/script.js"></script>
    <style>
        .admin-section { margin-bottom: 2rem; padding: 1.5rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .admin-section h2 { margin-bottom: 1rem; }
        .admin-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .admin-table th, .admin-table td { border: 1px solid #eee; padding: 0.5rem; text-align: left; }
        .admin-table th { background: #f7f7f7; }
        .flag-btn { color: #fff; background: #e74c3c; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; cursor: pointer; }
        .admin-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; }
        .admin-header h1 { font-size: 2rem; }
        .admin-menu {
            background: #fff;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 2rem;
        }
        .admin-menu ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0 2rem;
        }
        .admin-menu li {
            padding: 1rem 2rem;
            cursor: pointer;
            color: #555;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: background 0.2s, border-bottom 0.2s, color 0.2s;
        }
        .admin-menu li.active {
            background: #e3f0fa;
            color: #2176bd;
            border-bottom: 3px solid #2176bd;
        }
        .admin-menu li:hover:not(.active) {
            background: #f5faff;
            color: #2176bd;
        }
        .admin-header-bar {
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        .admin-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 5%;
            max-width: 1400px;
            margin: 0 auto;
        }
        .site-logo {
            height: 2.2rem;
            width: auto;
            margin-right: 1rem;
            display: block;
        }
        .admin-menu {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
            background: none;
            border: none;
            box-shadow: none;
        }
        .admin-menu li {
            padding: 0.7rem 1.5rem;
            cursor: pointer;
            color: #2c3e50;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            background: none;
            transition: background 0.2s, border-bottom 0.2s, color 0.2s;
            font-size: 1rem;
        }
        .admin-menu li.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: #f5faff;
        }
        .admin-menu li:hover:not(.active) {
            background: #f5faff;
            color: #3498db;
        }
        body {
            padding-top: 80px;
        }
        .admin-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        /* Remove old .admin-header and .admin-menu styles */
        .admin-submenu {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 1.2rem 0 1.5rem 0;
            padding: 0;
            border-bottom: 1.5px solid #eaeaea;
        }
        .admin-submenu li {
            padding: 0.6rem 1.3rem;
            cursor: pointer;
            color: #2c3e50;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            background: none;
            transition: background 0.2s, border-bottom 0.2s, color 0.2s;
            font-size: 1rem;
        }
        .admin-submenu li.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: #f5faff;
        }
        .admin-submenu li:hover:not(.active) {
            background: #f5faff;
            color: #3498db;
        }
        .admin-tab-content { display: none; }
        
        /* New Package Form Styles */
        .package-form {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-group input[type="file"] {
            padding: 0.5rem;
            border: 2px dashed #bdc3c7;
            background: #fff;
            cursor: pointer;
        }
        
        .form-group input[type="file"]:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .image-preview {
            margin-top: 1rem;
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            object-fit: cover;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e9ecef;
        }
        
        .btn-primary,
        .btn-secondary {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(149, 165, 166, 0.3);
        }
        
        /* Responsive design for form */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .package-form {
                padding: 1rem;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
        
        /* Admin table styles */
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .status-badge.available {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.limited {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-badge.pending {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .edit-btn, .delete-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background: #3498db;
            color: white;
        }
        
        .edit-btn:hover {
            background: #2980b9;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .flag-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.3s;
            background: #f39c12;
            color: white;
        }
        
        .flag-btn:hover {
            background: #e67e22;
        }
        
        /* Analytics Styles */
        .analytics-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .analytics-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .analytics-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .demographics-grid .chart-container {
            height: 250px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
            display: block;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .revenue-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .revenue-item {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .revenue-label {
            display: block;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .revenue-value {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: #27ae60;
        }
        
        .package-revenue {
            margin-top: 1rem;
        }
        
        .package-revenue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
        }
        
        .package-revenue-item:last-child {
            border-bottom: none;
        }
        
        .package-name {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .package-amount {
            font-weight: bold;
            color: #27ae60;
        }
        
        .demographics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .demographic-item h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .customer-list, .package-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .customer-item, .package-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .customer-item:last-child, .package-item:last-child {
            border-bottom: none;
        }
        
        .customer-name, .package-name {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .customer-orders, .package-count {
            background: #3498db;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .analytics-container {
                grid-template-columns: 1fr;
            }
            
            .demographics-grid {
                grid-template-columns: 1fr;
            }
            
            .revenue-summary {
                grid-template-columns: 1fr;
            }
        }
        .go-badge-btn {
            display: inline-block;
            margin-left: 0.7em;
            padding: 0.28em 1.1em;
            font-size: 0.98em;
            border-radius: 20px;
            background: #3498db;
            color: #fff !important;
            text-decoration: none;
            font-weight: 600;
            transition: background 0.18s, box-shadow 0.18s;
            box-shadow: 0 1px 4px rgba(52,152,219,0.07);
            border: none;
            opacity: 0.92;
            vertical-align: middle;
        }
        .go-badge-btn:hover {
            background: #2176bd;
            opacity: 1;
        }
    </style>
</head>
<body>
    <header class="admin-header-bar">
        <nav class="admin-nav">
            <div class="logo" style="display: flex; align-items: center;">
                <img src="images/logo.jpg" alt="Hikayat Logo" class="site-logo">
                <h1 style="margin: 0; font-size: 1.5rem;">HIKAYAT TRAVELS & TOURS</h1>
            </div>
            <ul class="admin-menu">
                <li class="active" data-section="order-history-section">Order History</li>
                <li data-section="manage-packages-section">Manage Packages</li>
                <li data-section="promo-offer-section">Promotional Offers</li>
                <li data-section="analytics-section">Analytics</li>
                <li data-section="reviews-section">Reviews</li>
                <li style="margin-left:auto;"><button id="admin-logout-btn" style="background:#3498db;color:#fff;border:none;padding:0.5rem 1.2rem;border-radius:5px;cursor:pointer;">Logout</button></li>
            </ul>
        </nav>
    </header>

    <div class="admin-section" id="order-history-section">
        <h2>Customer Order History</h2>
        <ul class="admin-submenu" id="order-history-tabs">
            <li class="active" data-tab="all-orders">All Orders</li>
            <li data-tab="pending-orders">Pending</li>
            <li data-tab="completed-orders">Completed</li>
            <li data-tab="cancelled-orders">Cancelled</li>
        </ul>
        <div class="admin-tab-content" id="all-orders" style="display:block;">
            <table class="admin-table" id="order-history-table">
                <thead>
                    <tr><th>Order ID</th><th>Customer</th><th>Package</th><th>Date</th><th>Status</th><th>Reservation</th></tr>
                </thead>
                <tbody>
                    <!-- Orders will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
        <div class="admin-tab-content" id="pending-orders" style="display:none;">
            <table class="admin-table" id="pending-orders-table">
                <thead>
                    <tr><th>Order ID</th><th>Customer</th><th>Package</th><th>Date</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    <!-- Pending orders will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
        <div class="admin-tab-content" id="completed-orders" style="display:none;">
            <table class="admin-table" id="completed-orders-table">
                <thead>
                    <tr><th>Order ID</th><th>Customer</th><th>Package</th><th>Date</th><th>Status</th><th>Reservation</th></tr>
                </thead>
                <tbody>
                    <!-- Completed orders will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
        <div class="admin-tab-content" id="cancelled-orders" style="display:none;">
            <table class="admin-table" id="cancelled-orders-table">
                <thead>
                    <tr><th>Order ID</th><th>Customer</th><th>Package</th><th>Date</th><th>Status</th><th>Reservation</th></tr>
                </thead>
                <tbody>
                    <!-- Cancelled orders will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="admin-section" id="manage-packages-section">
        <h2>Manage Packages</h2>
        <ul class="admin-submenu" id="manage-packages-tabs">
            <li class="active" data-tab="all-packages">Ongoing Package</li>
            <li data-tab="add-package">Add New</li>
            <li data-tab="unavailable-packages">Unavailable</li>
        </ul>
        <div class="admin-tab-content" id="all-packages" style="display:block;">
            <table class="admin-table" id="packages-table">
                <thead>
                    <tr><th>Image</th><th>Name</th><th>Location</th><th>Duration</th><th>Price</th><th>Availability</th><th>Actions</th></tr>
                </thead>
                <tbody id="packages-table-body">
                    <!-- Package details will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
        <div class="admin-tab-content" id="add-package" style="display:none;">
            <form id="new-package-form" class="package-form">
                <div class="form-group">
                    <label for="package-title">Package Title *</label>
                    <input type="text" id="package-title" name="title" placeholder="Enter package title" required>
                </div>
                
                <div class="form-group">
                    <label for="package-image">Package Image *</label>
                    <input type="file" id="package-image" name="image" accept="image/*" required>
                    <div id="image-preview" class="image-preview"></div>
                </div>
                
                <div class="form-group">
                    <label for="package-description">Description *</label>
                    <textarea id="package-description" name="description" placeholder="Enter detailed package description" rows="4" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="package-duration">Duration (Days) *</label>
                        <input type="number" id="package-duration" name="duration" placeholder="e.g., 7" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="package-price">Price (RM) *</label>
                        <input type="number" id="package-price" name="price" placeholder="e.g., 1500" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="package-availability">Availability Status *</label>
                    <select id="package-availability" name="availability" required>
                        <option value="">Select availability</option>
                        <option value="available">Available</option>
                        <option value="limited">Limited</option>
                        <option value="unavailable">Unavailable</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="package-location">Location/Destination *</label>
                    <input type="text" id="package-location" name="location" placeholder="e.g., Langkawi, Malaysia" required>
                </div>
                
                <div class="form-group">
                    <label for="package-highlights">Highlights (Optional)</label>
                    <textarea id="package-highlights" name="highlights" placeholder="Enter key highlights of the package" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Create Package</button>
                    <button type="reset" class="btn-secondary">Reset Form</button>
                </div>
            </form>
        </div>
        
        <div class="admin-tab-content" id="edit-package-form-container" style="display:none;">
            <form id="edit-package-form" class="package-form">
                <input type="hidden" id="edit-package-id" name="id">
                
                <div class="form-group">
                    <label for="edit-package-title">Package Title *</label>
                    <input type="text" id="edit-package-title" name="title" placeholder="Enter package title" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-package-image">Package Image</label>
                    <input type="file" id="edit-package-image" name="image" accept="image/*">
                    <div id="edit-image-preview" class="image-preview"></div>
                    <small style="color: #666; margin-top: 0.5rem; display: block;">Leave empty to keep current image</small>
                </div>
                
                <div class="form-group">
                    <label for="edit-package-description">Description *</label>
                    <textarea id="edit-package-description" name="description" placeholder="Enter detailed package description" rows="4" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-package-duration">Duration (Days) *</label>
                        <input type="number" id="edit-package-duration" name="duration" placeholder="e.g., 7" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-package-price">Price (RM) *</label>
                        <input type="number" id="edit-package-price" name="price" placeholder="e.g., 1500" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-package-availability">Availability Status *</label>
                    <select id="edit-package-availability" name="availability" required>
                        <option value="">Select availability</option>
                        <option value="available">Available</option>
                        <option value="limited">Limited</option>
                        <option value="unavailable">Unavailable</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-package-location">Location/Destination *</label>
                    <input type="text" id="edit-package-location" name="location" placeholder="e.g., Langkawi, Malaysia" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-package-highlights">Highlights (Optional)</label>
                    <textarea id="edit-package-highlights" name="highlights" placeholder="Enter key highlights of the package" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Update Package</button>
                    <button type="button" class="btn-secondary" onclick="cancelEdit()">Cancel</button>
                </div>
            </form>
        </div>
        
        <div class="admin-tab-content" id="unavailable-packages" style="display:none;">
            <table class="admin-table" id="unavailable-packages-table">
                <thead>
                    <tr><th>Image</th><th>Name</th><th>Location</th><th>Duration</th><th>Price</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="unavailable-packages-table-body">
                    <!-- Unavailable packages will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="admin-section" id="promo-offer-section">
        <h2>Update Promotional Offer</h2>
        <ul class="admin-submenu" id="promo-offer-tabs">
            <li class="active" data-tab="current-offer">Current Offer</li>
            <li data-tab="update-offer">Update Offer</li>
        </ul>
        <div class="admin-tab-content" id="current-offer" style="display:block;">
            <div id="current-promo">
                <!-- Current promo details will be shown here -->
            </div>
        </div>
        <div class="admin-tab-content" id="update-offer" style="display:none;">
            <form id="promo-form" class="package-form">
                <div class="form-group">
                    <label for="promo-code">Promo Code *</label>
                    <input type="text" id="promo-code" name="promo-code" placeholder="Enter promo code" required>
                </div>
                <div class="form-group">
                    <label for="promo-discount">Discount (%) *</label>
                    <input type="number" id="promo-discount" name="promo-discount" placeholder="Enter discount percentage" min="1" max="100" required>
                </div>
                <div class="form-group">
                    <label for="promo-end-date">End Promotion Date (Optional)</label>
                    <input type="date" id="promo-end-date" name="promo-end-date">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Update Offer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="admin-section" id="analytics-section">
        <h2>Weekly Report & Analytics</h2>
        <ul class="admin-submenu" id="analytics-tabs">
            <li class="active" data-tab="booking-trends">Booking Trends</li>
            <li data-tab="revenue">Revenue</li>
            <li data-tab="demographics">Customer Demographics</li>
        </ul>
        <div class="admin-tab-content" id="booking-trends" style="display:block;">
            <div class="analytics-container">
                <div class="analytics-card">
                    <h3>Booking Trends (Last 6 Months)</h3>
                    <div id="booking-trends-chart" class="chart-container">
                        <canvas id="bookingTrendsChart"></canvas>
                    </div>
                </div>
                <div class="analytics-card">
                    <h3>Monthly Booking Statistics</h3>
                    <div id="monthly-stats" class="stats-grid">
                        <!-- Monthly stats will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="admin-tab-content" id="revenue" style="display:none;">
            <div class="analytics-container">
                <div class="analytics-card">
                    <h3>Revenue Overview</h3>
                    <div class="revenue-summary">
                        <div class="revenue-item">
                            <span class="revenue-label">Total Revenue</span>
                            <span class="revenue-value" id="total-revenue">RM 0.00</span>
                        </div>
                        <div class="revenue-item">
                            <span class="revenue-label">Average Order Value</span>
                            <span class="revenue-value" id="avg-order-value">RM 0.00</span>
                        </div>
                        <div class="revenue-item">
                            <span class="revenue-label">Total Orders</span>
                            <span class="revenue-value" id="total-orders">0</span>
                        </div>
                    </div>
                </div>
                <div class="analytics-card">
                    <h3>Revenue by Package</h3>
                    <div id="revenue-by-package" class="package-revenue">
                        <!-- Package revenue breakdown will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="admin-tab-content" id="demographics" style="display:none;">
            <div class="analytics-container">
                <div class="analytics-card">
                    <h3>Customer Demographics</h3>
                    <div class="demographics-grid">
                        <div class="demographic-item">
                            <h4>Top Customers</h4>
                            <div id="top-customers" class="customer-list">
                                <!-- Top customers will be loaded here -->
                            </div>
                        </div>
                        <div class="demographic-item">
                            <h4>Popular Packages</h4>
                            <div id="popular-packages" class="package-list">
                                <!-- Popular packages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <h3>Customer Demographics Charts</h3>
                    <div class="demographics-grid">
                        <div class="demographic-item">
                            <h4>Top Customers by Revenue</h4>
                            <div class="chart-container">
                                <canvas id="topCustomersChart"></canvas>
                            </div>
                        </div>
                        <div class="demographic-item">
                            <h4>Popular Packages</h4>
                            <div class="chart-container">
                                <canvas id="popularPackagesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-section" id="reviews-section">
        <h2>Manage Reviews & Ratings</h2>
        <ul class="admin-submenu" id="reviews-tabs">
            <li class="active" data-tab="all-reviews">All Reviews</li>
            <li data-tab="flagged-reviews">Flagged</li>
        </ul>
        <div class="admin-tab-content" id="all-reviews" style="display:block;">
            <table class="admin-table" id="reviews-table">
                <thead>
                    <tr><th>Customer</th><th>Package</th><th>Rating</th><th>Review</th><th>Date</th><th>Actions</th></tr>
                </thead>
                <tbody id="reviews-table-body">
                    <!-- Reviews will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
        <div class="admin-tab-content" id="flagged-reviews" style="display:none;">
            <table class="admin-table" id="flagged-reviews-table">
                <thead>
                    <tr><th>Customer</th><th>Package</th><th>Rating</th><th>Review</th><th>Date</th><th>Actions</th></tr>
                </thead>
                <tbody id="flagged-reviews-table-body">
                    <!-- Flagged reviews will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="js/default-packages.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // --- Admin Access Control ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Setting up admin panel');
        
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'admin') {
            window.location.href = 'index.html';
            return;
        }
        
        // Admin menu logic
        const menuItems = document.querySelectorAll('.admin-menu li');
        const sections = [
            'order-history-section',
            'manage-packages-section',
            'promo-offer-section',
            'analytics-section',
            'reviews-section'
        ];
        function showSection(sectionId) {
            sections.forEach(id => {
                document.getElementById(id).style.display = (id === sectionId) ? 'block' : 'none';
            });
        }
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                showSection(this.getAttribute('data-section'));
            });
        });
        // Show only the first section by default
        showSection('order-history-section');
        
        // Setup package form functionality
        setupPackageForm();
        
        // Setup edit package form functionality
        setupEditPackageForm();

        // Promo offer form functionality
        const promoForm = document.getElementById('promo-form');
        if (promoForm) {
            promoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const code = document.getElementById('promo-code').value.trim();
                const discount = parseInt(document.getElementById('promo-discount').value);
                const endDate = document.getElementById('promo-end-date').value;
                if (!code || isNaN(discount) || discount < 1 || discount > 100) {
                    alert('Please enter a valid promo code and discount percentage (1-100).');
                    return;
                }
                let promos = JSON.parse(localStorage.getItem('promos') || '[]');
                // Prevent duplicate codes
                if (promos.some(p => p.code.toLowerCase() === code.toLowerCase())) {
                    alert('Promo code already exists. Please use a different code.');
                    return;
                }
                promos.push({ code, discount, endDate });
                localStorage.setItem('promos', JSON.stringify(promos));
                const msg = document.createElement('div');
                msg.textContent = 'Promo offer added!';
                msg.style.background = '#e3f9e5';
                msg.style.color = '#217a3c';
                msg.style.padding = '0.7rem 1.2rem';
                msg.style.borderRadius = '6px';
                msg.style.marginTop = '1rem';
                msg.style.textAlign = 'center';
                promoForm.appendChild(msg);
                setTimeout(() => msg.remove(), 2000);
                promoForm.reset();
                showCurrentPromos();
            });
        }

        // Always show current promos on page load
        showCurrentPromos();
    });
    
    // Function to setup package form
    function setupPackageForm() {
        console.log('Setting up package form');
        
        const packageForm = document.getElementById('new-package-form');
        const imageInput = document.getElementById('package-image');
        const imagePreview = document.getElementById('image-preview');
        
        console.log('Package form found:', packageForm);
        console.log('Image input found:', imageInput);
        console.log('Image preview found:', imagePreview);
        
        // Load packages on page load
        loadPackages();
        
        // Image preview functionality with compression
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                console.log('Image input changed');
                const file = e.target.files[0];
                if (file) {
                    // Compress image before storing
                    compressImage(file, function(compressedDataUrl) {
                        imagePreview.innerHTML = `<img src="${compressedDataUrl}" alt="Preview">`;
                        imagePreview.style.display = 'block';
                    });
                } else {
                    imagePreview.style.display = 'none';
                    imagePreview.innerHTML = '';
                }
            });
        }
        
        // Form submission handling
        if (packageForm) {
            console.log('Setting up form submission handler');
            packageForm.addEventListener('submit', function(e) {
                console.log('Form submitted');
                e.preventDefault();
                
                // Get form data
                const formData = new FormData(packageForm);
                const packageData = {
                    id: Date.now(), // Generate unique ID
                    title: formData.get('title'),
                    description: formData.get('description'),
                    duration: parseInt(formData.get('duration')),
                    price: parseFloat(formData.get('price')),
                    availability: formData.get('availability'),
                    location: formData.get('location'),
                    highlights: formData.get('highlights'),
                    image: imagePreview.querySelector('img')?.src || 'images/noimage.jpg',
                    createdAt: new Date().toISOString()
                };
                
                console.log('Package data:', packageData);
                
                // Validate required fields
                if (!packageData.title || !packageData.description || !packageData.duration || 
                    !packageData.price || !packageData.availability || !packageData.location) {
                    alert('Please fill in all required fields marked with *');
                    console.log('Validation failed');
                    return;
                }
                
                // Check localStorage size before saving
                try {
                    // Save package to localStorage (in a real app, this would go to a database)
                    const existingPackages = JSON.parse(localStorage.getItem('packages') || '[]');
                    existingPackages.push(packageData);
                    
                    // Try to save and catch quota exceeded error
                    localStorage.setItem('packages', JSON.stringify(existingPackages));
                    
                    console.log('Package saved to localStorage');
                    
                    // Show success message
                    alert('Package created successfully!');
                    
                    // Reset form
                    packageForm.reset();
                    imagePreview.style.display = 'none';
                    imagePreview.innerHTML = '';
                    
                    // Reload packages to show the new one
                    loadPackages();
                    loadUnavailablePackages();
                    
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        alert('Storage limit reached! Please clear some data or contact administrator.');
                        console.error('localStorage quota exceeded:', error);
                    } else {
                        alert('Error saving package: ' + error.message);
                        console.error('Error saving package:', error);
                    }
                }
            });
        } else {
            console.error('Package form not found!');
        }
    }
    
    // Function to compress images
    function compressImage(file, callback) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // Set maximum dimensions
            const maxWidth = 800;
            const maxHeight = 600;
            
            let width = img.width;
            let height = img.height;
            
            // Calculate new dimensions
            if (width > height) {
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }
            }
            
            // Set canvas dimensions
            canvas.width = width;
            canvas.height = height;
            
            // Draw and compress image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to compressed data URL (0.7 quality for good compression)
            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
            callback(compressedDataUrl);
        };
        
        img.src = URL.createObjectURL(file);
    }
    
    // Function to check localStorage usage
    function checkStorageUsage() {
        let totalSize = 0;
        const packages = JSON.parse(localStorage.getItem('packages') || '[]');
        
        // Calculate size of packages data
        const packagesSize = JSON.stringify(packages).length;
        totalSize += packagesSize;
        
        console.log('Packages data size:', packagesSize, 'characters');
        console.log('Total localStorage usage:', totalSize, 'characters');
        
        // Warn if approaching limit (5MB = ~5,000,000 characters)
        if (totalSize > 4000000) {
            alert('Warning: Storage is getting full. Consider clearing old packages.');
        }
        
        return totalSize;
    }
    
    // Function to clear old packages (keep only recent 10)
    function clearOldPackages() {
        const packages = JSON.parse(localStorage.getItem('packages') || '[]');
        
        if (packages.length > 10) {
            // Sort by creation date and keep only the 10 most recent
            packages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const recentPackages = packages.slice(0, 10);
            
            localStorage.setItem('packages', JSON.stringify(recentPackages));
            alert('Cleared old packages. Kept the 10 most recent packages.');
            
            // Reload displays
            loadPackages();
            loadUnavailablePackages();
        } else {
            alert('No old packages to clear. You have ' + packages.length + ' packages.');
        }
    }
    
    // Function to setup edit package form
    function setupEditPackageForm() {
        const editForm = document.getElementById('edit-package-form');
        const editImageInput = document.getElementById('edit-package-image');
        const editImagePreview = document.getElementById('edit-image-preview');
        
        // Edit image preview functionality
        if (editImageInput) {
            editImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                        editImagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    editImagePreview.style.display = 'none';
                    editImagePreview.innerHTML = '';
                }
            });
        }
        
        // Edit form submission
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(editForm);
                const packageId = parseInt(formData.get('id'));
                
                const updatedPackageData = {
                    id: packageId,
                    title: formData.get('title'),
                    description: formData.get('description'),
                    duration: parseInt(formData.get('duration')),
                    price: parseFloat(formData.get('price')),
                    availability: formData.get('availability'),
                    location: formData.get('location'),
                    highlights: formData.get('highlights'),
                    image: editImagePreview.querySelector('img')?.src || document.getElementById('edit-package-id').getAttribute('data-current-image'),
                    createdAt: document.getElementById('edit-package-id').getAttribute('data-created-at')
                };
                
                // Validate required fields
                if (!updatedPackageData.title || !updatedPackageData.description || !updatedPackageData.duration || 
                    !updatedPackageData.price || !updatedPackageData.availability || !updatedPackageData.location) {
                    alert('Please fill in all required fields marked with *');
                    return;
                }
                
                // Update package in localStorage
                const packages = JSON.parse(localStorage.getItem('packages') || '[]');
                const packageIndex = packages.findIndex(pkg => pkg.id === packageId);
                
                if (packageIndex !== -1) {
                    packages[packageIndex] = updatedPackageData;
                    localStorage.setItem('packages', JSON.stringify(packages));
                    
                    // Show success message
                    alert('Package updated successfully!');
                    
                    // Hide edit form and show packages table
                    cancelEdit();
                    
                    // Reload packages
                    loadPackages();
                    loadUnavailablePackages();
                } else {
                    alert('Package not found!');
                }
            });
        }
    }
    
    // Function to load and display packages
    function loadPackages() {
        const packagesTableBody = document.getElementById('packages-table-body');
        const packages = JSON.parse(localStorage.getItem('packages') || '[]');
        
        if (packagesTableBody) {
            packagesTableBody.innerHTML = '';
            
            // Filter to show only available and limited packages
            const availablePackages = packages.filter(pkg => pkg.availability === 'available' || pkg.availability === 'limited');
            
            if (availablePackages.length === 0) {
                packagesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No ongoing packages found. Create your first package!</td></tr>';
                return;
            }
            
            availablePackages.forEach(package => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <img src="${package.image}" alt="${package.title}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">
                    </td>
                    <td>${package.title}</td>
                    <td>${package.location}</td>
                    <td>${package.duration} Days</td>
                    <td>RM ${package.price.toFixed(2)}</td>
                    <td>
                        <span class="status-badge ${package.availability}">${package.availability}</span>
                    </td>
                    <td>
                        <button onclick="editPackage(${package.id})" class="edit-btn">Edit</button>
                        <button onclick="deletePackage(${package.id})" class="delete-btn">Delete</button>
                    </td>
                `;
                packagesTableBody.appendChild(row);
            });
        }
    }
    
    // Function to load unavailable packages
    function loadUnavailablePackages() {
        const unavailableTableBody = document.getElementById('unavailable-packages-table-body');
        const packages = JSON.parse(localStorage.getItem('packages') || '[]');
        
        if (unavailableTableBody) {
            unavailableTableBody.innerHTML = '';
            
            // Filter to show only unavailable packages
            const unavailablePackages = packages.filter(pkg => pkg.availability === 'unavailable');
            
            if (unavailablePackages.length === 0) {
                unavailableTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No unavailable packages found.</td></tr>';
                return;
            }
            
            unavailablePackages.forEach(package => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <img src="${package.image}" alt="${package.title}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">
                    </td>
                    <td>${package.title}</td>
                    <td>${package.location}</td>
                    <td>${package.duration} Days</td>
                    <td>RM ${package.price.toFixed(2)}</td>
                    <td>
                        <span class="status-badge ${package.availability}">${package.availability}</span>
                    </td>
                    <td>
                        <button onclick="editPackage(${package.id})" class="edit-btn">Edit</button>
                        <button onclick="deletePackage(${package.id})" class="delete-btn">Delete</button>
                    </td>
                `;
                unavailableTableBody.appendChild(row);
            });
        }
    }
    
    // Function to edit package
    function editPackage(packageId) {
        const packages = JSON.parse(localStorage.getItem('packages') || '[]');
        const package = packages.find(pkg => pkg.id === packageId);
        
        if (package) {
            // Hide packages table and show edit form
            const packagesTable = document.getElementById('all-packages');
            const editFormContainer = document.getElementById('edit-package-form-container');
            
            if (packagesTable && editFormContainer) {
                packagesTable.style.display = 'none';
                editFormContainer.style.display = 'block';
            }
            
            // Populate form fields
            document.getElementById('edit-package-id').value = package.id;
            document.getElementById('edit-package-id').setAttribute('data-current-image', package.image);
            document.getElementById('edit-package-id').setAttribute('data-created-at', package.createdAt);
            document.getElementById('edit-package-title').value = package.title;
            document.getElementById('edit-package-description').value = package.description;
            document.getElementById('edit-package-duration').value = package.duration;
            document.getElementById('edit-package-price').value = package.price;
            document.getElementById('edit-package-availability').value = package.availability;
            document.getElementById('edit-package-location').value = package.location;
            document.getElementById('edit-package-highlights').value = package.highlights || '';
            
            // Show current image
            const editImagePreview = document.getElementById('edit-image-preview');
            editImagePreview.innerHTML = `<img src="${package.image}" alt="Current Image">`;
            editImagePreview.style.display = 'block';
        }
    }
    
    // Function to cancel edit
    function cancelEdit() {
        const packagesTable = document.getElementById('all-packages');
        const editFormContainer = document.getElementById('edit-package-form-container');
        const editForm = document.getElementById('edit-package-form');
        const editImagePreview = document.getElementById('edit-image-preview');
        
        if (packagesTable && editFormContainer) {
            packagesTable.style.display = 'block';
            editFormContainer.style.display = 'none';
        }
        
        if (editForm) {
            editForm.reset();
        }
        
        if (editImagePreview) {
            editImagePreview.style.display = 'none';
            editImagePreview.innerHTML = '';
        }
    }
    
    // Function to delete package
    function deletePackage(packageId) {
        if (confirm('Are you sure you want to delete this package?')) {
            const packages = JSON.parse(localStorage.getItem('packages') || '[]');
            const updatedPackages = packages.filter(pkg => pkg.id !== packageId);
            localStorage.setItem('packages', JSON.stringify(updatedPackages));
            loadPackages();
            loadUnavailablePackages();
            alert('Package deleted successfully!');
        }
    }
    
    // Admin submenu logic
    function setupAdminTabs(tabGroupId) {
        const tabGroup = document.getElementById(tabGroupId);
        if (!tabGroup) return;
        const tabs = tabGroup.querySelectorAll('li');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const section = this.getAttribute('data-tab');
                const contents = document.querySelectorAll('.admin-tab-content');
                contents.forEach(content => {
                    if (content.id === section) {
                        content.style.display = 'block';
                        // Load appropriate packages based on tab
                        if (section === 'all-packages') {
                            loadPackages();
                        } else if (section === 'unavailable-packages') {
                            loadUnavailablePackages();
                        }
                    } else if (tabGroup.parentElement.contains(content)) {
                        content.style.display = 'none';
                    }
                });
            });
        });
    }
    
    // Setup admin tabs
    setupAdminTabs('order-history-tabs');
    setupAdminTabs('manage-packages-tabs');
    setupAdminTabs('promo-offer-tabs');
    setupAdminTabs('analytics-tabs');
    setupAdminTabs('reviews-tabs');
    
    // Custom setup for reviews tabs to load appropriate data
    const reviewsTabGroup = document.getElementById('reviews-tabs');
    if (reviewsTabGroup) {
        const reviewTabs = reviewsTabGroup.querySelectorAll('li');
        reviewTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                reviewTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const section = this.getAttribute('data-tab');
                const contents = document.querySelectorAll('.admin-tab-content');
                contents.forEach(content => {
                    if (content.id === section) {
                        content.style.display = 'block';
                        // Load appropriate reviews based on tab
                        if (section === 'all-reviews') {
                            loadReviews();
                        } else if (section === 'flagged-reviews') {
                            loadFlaggedReviews();
                        }
                    } else if (reviewsTabGroup.parentElement.contains(content)) {
                        content.style.display = 'none';
                    }
                });
            });
        });
    }

    // Logout functionality
    document.getElementById('admin-logout-btn').onclick = function() {
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    };

    function showCurrentPromos() {
        const currentPromoDiv = document.getElementById('current-promo');
        if (currentPromoDiv) {
            const promos = JSON.parse(localStorage.getItem('promos') || '[]');
            if (promos.length > 0) {
                currentPromoDiv.innerHTML = promos.map((promo, idx) => {
                    let endDateStr = '';
                    if (promo.endDate) {
                        const dateObj = new Date(promo.endDate);
                        const day = dateObj.getDate().toString().padStart(2, '0');
                        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                        const year = dateObj.getFullYear();
                        endDateStr = `<br><strong>End Date:</strong> <span style="color:#e67e22;">${day}/${month}/${year}</span>`;
                    }
                    return `
                        <div style="padding:1rem; background:#f5faff; border-radius:8px; margin-bottom:1rem;">
                            <strong>Promo Code:</strong> <span style="color:#3498db;">${promo.code}</span><br>
                            <strong>Discount:</strong> <span style="color:#27ae60;">${promo.discount}%</span>
                            ${endDateStr}
                            <br><button class="delete-promo-btn" data-idx="${idx}" style="margin-top:1rem; background:#e74c3c; color:#fff; border:none; padding:0.5rem 1.2rem; border-radius:5px; cursor:pointer;">Delete Offer</button>
                        </div>
                    `;
                }).join('');
                setTimeout(() => {
                    document.querySelectorAll('.delete-promo-btn').forEach(btn => {
                        btn.onclick = function() {
                            const idx = parseInt(this.getAttribute('data-idx'));
                            if (confirm('Are you sure you want to delete this promo offer?')) {
                                let promos = JSON.parse(localStorage.getItem('promos') || '[]');
                                promos.splice(idx, 1);
                                localStorage.setItem('promos', JSON.stringify(promos));
                                showCurrentPromos();
                            }
                        };
                    });
                }, 0);
            } else {
                currentPromoDiv.innerHTML = `<div style="color:#888;">No current promo offers set.</div>`;
            }
        }
    }

    // Function to load and display reviews
    function loadReviews() {
        const reviewsTableBody = document.getElementById('reviews-table-body');
        const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
        
        if (reviewsTableBody) {
            reviewsTableBody.innerHTML = '';
            
            // Filter out flagged reviews - only show unflagged reviews in All Reviews tab
            const unflaggedReviews = reviews.filter(review => !review.flagged);
            
            if (unflaggedReviews.length === 0) {
                reviewsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No reviews found.</td></tr>';
                return;
            }
            
            unflaggedReviews.forEach(review => {
                const reviewDate = new Date(review.createdAt);
                const day = reviewDate.getDate().toString().padStart(2, '0');
                const month = (reviewDate.getMonth() + 1).toString().padStart(2, '0');
                const year = reviewDate.getFullYear();
                
                // Show rating as number (e.g., 4/5)
                const ratingText = `${review.rating} / 5`;
                
                // Get customer name from user profile if available
                const userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
                const userProfile = userProfiles[review.userId] || {};
                const customerName = userProfile.fullName || review.userName || review.userId || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customerName}</td>
                    <td>${review.packageName}</td>
                    <td>${ratingText}</td>
                    <td style="max-width: 300px; word-wrap: break-word;">${review.comment}</td>
                    <td>${day}/${month}/${year}</td>
                    <td>
                        <button onclick="flagReview(${review.id})" class="flag-btn">Flag</button>
                    </td>
                `;
                reviewsTableBody.appendChild(row);
            });
        }
    }

    // Function to flag review
    function flagReview(reviewId) {
        if (confirm('Are you sure you want to flag this review for moderation?')) {
            const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
            const reviewIndex = reviews.findIndex(review => review.id === reviewId);
            
            if (reviewIndex !== -1) {
                reviews[reviewIndex].flagged = true;
                reviews[reviewIndex].flaggedAt = new Date().toISOString();
                localStorage.setItem('reviews', JSON.stringify(reviews));
                loadReviews();
                loadFlaggedReviews();
                alert('Review flagged successfully!');
            } else {
                alert('Review not found!');
            }
        }
    }
    
    // Function to load flagged reviews
    function loadFlaggedReviews() {
        const flaggedReviewsTableBody = document.getElementById('flagged-reviews-table-body');
        const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
        const flaggedReviews = reviews.filter(review => review.flagged === true);
        
        if (flaggedReviewsTableBody) {
            flaggedReviewsTableBody.innerHTML = '';
            
            if (flaggedReviews.length === 0) {
                flaggedReviewsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No flagged reviews found.</td></tr>';
                return;
            }
            
            flaggedReviews.forEach(review => {
                const reviewDate = new Date(review.createdAt);
                const day = reviewDate.getDate().toString().padStart(2, '0');
                const month = (reviewDate.getMonth() + 1).toString().padStart(2, '0');
                const year = reviewDate.getFullYear();
                
                // Show rating as number (e.g., 4/5)
                const ratingText = `${review.rating} / 5`;
                
                // Get customer name from user profile if available
                const userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
                const userProfile = userProfiles[review.userId] || {};
                const customerName = userProfile.fullName || review.userName || review.userId || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customerName}</td>
                    <td>${review.packageName}</td>
                    <td>${ratingText}</td>
                    <td style="max-width: 300px; word-wrap: break-word;">${review.comment}</td>
                    <td>${day}/${month}/${year}</td>
                    <td>
                        <button onclick="unflagReview(${review.id})" class="edit-btn">Unflag</button>
                        <button onclick="deleteReview(${review.id})" class="delete-btn">Delete</button>
                    </td>
                `;
                flaggedReviewsTableBody.appendChild(row);
            });
        }
    }
    
    // Function to unflag review
    function unflagReview(reviewId) {
        if (confirm('Are you sure you want to unflag this review?')) {
            const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
            const reviewIndex = reviews.findIndex(review => review.id === reviewId);
            
            if (reviewIndex !== -1) {
                reviews[reviewIndex].flagged = false;
                delete reviews[reviewIndex].flaggedAt;
                localStorage.setItem('reviews', JSON.stringify(reviews));
                loadReviews();
                loadFlaggedReviews();
                alert('Review unflagged successfully!');
            } else {
                alert('Review not found!');
            }
        }
    }
    
    // Function to delete review (now only available in flagged reviews)
    function deleteReview(reviewId) {
        if (confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
            const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
            const updatedReviews = reviews.filter(review => review.id !== reviewId);
            localStorage.setItem('reviews', JSON.stringify(updatedReviews));
            loadReviews();
            loadFlaggedReviews();
            alert('Review deleted successfully!');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadReviews();
        loadFlaggedReviews();
        loadOrderHistory();
        loadAnalytics();
    });
    
    // Function to load all analytics
    function loadAnalytics() {
        loadBookingTrends();
        loadRevenueAnalytics();
        loadCustomerDemographics();
    }
    
    // Function to load booking trends
    function loadBookingTrends() {
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const monthlyStats = document.getElementById('monthly-stats');
        
        if (monthlyStats) {
            // Calculate monthly statistics
            const monthlyData = {};
            const currentDate = new Date();
            
            // Initialize last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                monthlyData[monthKey] = { bookings: 0, revenue: 0 };
            }
            
            // Process bookings
            bookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt);
                const monthKey = bookingDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                
                if (monthlyData[monthKey]) {
                    monthlyData[monthKey].bookings++;
                    monthlyData[monthKey].revenue += booking.totalAmount;
                }
            });
            
            // Display monthly stats
            let statsHTML = '';
            Object.entries(monthlyData).forEach(([month, data]) => {
                statsHTML += `
                    <div class="stat-item">
                        <span class="stat-value">${data.bookings}</span>
                        <span class="stat-label">${month} Bookings</span>
                    </div>
                `;
            });
            
            monthlyStats.innerHTML = statsHTML;
            
            // Create booking trends chart
            createBookingTrendsChart(monthlyData);
        }
    }
    
    // Function to create booking trends chart
    function createBookingTrendsChart(monthlyData) {
        const ctx = document.getElementById('bookingTrendsChart');
        if (!ctx) return;
        
        const labels = Object.keys(monthlyData);
        const bookingData = Object.values(monthlyData).map(data => data.bookings);
        const revenueData = Object.values(monthlyData).map(data => data.revenue);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Bookings',
                    data: bookingData,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: 'Revenue (RM)',
                    data: revenueData,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Number of Bookings'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Revenue (RM)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Booking Trends & Revenue'
                    }
                }
            }
        });
    }
    
    // Function to load revenue analytics
    function loadRevenueAnalytics() {
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        
        // Calculate total revenue
        const totalRevenue = bookings.reduce((sum, booking) => sum + booking.totalAmount, 0);
        const totalOrders = bookings.length;
        const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
        
        // Update revenue summary
        document.getElementById('total-revenue').textContent = `RM ${totalRevenue.toFixed(2)}`;
        document.getElementById('avg-order-value').textContent = `RM ${avgOrderValue.toFixed(2)}`;
        document.getElementById('total-orders').textContent = totalOrders;
        
        // Calculate revenue by package
        const packageRevenue = {};
        bookings.forEach(booking => {
            if (packageRevenue[booking.packageName]) {
                packageRevenue[booking.packageName] += booking.totalAmount;
            } else {
                packageRevenue[booking.packageName] = booking.totalAmount;
            }
        });
        
        // Display package revenue
        const packageRevenueContainer = document.getElementById('revenue-by-package');
        if (packageRevenueContainer) {
            let packageHTML = '';
            Object.entries(packageRevenue)
                .sort(([,a], [,b]) => b - a) // Sort by revenue descending
                .forEach(([packageName, revenue]) => {
                    packageHTML += `
                        <div class="package-revenue-item">
                            <span class="package-name">${packageName}</span>
                            <span class="package-amount">RM ${revenue.toFixed(2)}</span>
                        </div>
                    `;
                });
            
            if (packageHTML === '') {
                packageHTML = '<p style="text-align: center; color: #7f8c8d;">No revenue data available</p>';
            }
            
            packageRevenueContainer.innerHTML = packageHTML;
        }
    }
    
    // Function to load customer demographics
    function loadCustomerDemographics() {
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
        
        // Calculate customer order counts for text display
        const customerOrders = {};
        bookings.forEach(booking => {
            const userProfile = userProfiles[booking.user?.email] || {};
            const customerName = userProfile.fullName || booking.user?.name || booking.user?.email || 'Unknown';
            
            if (customerOrders[customerName]) {
                customerOrders[customerName]++;
            } else {
                customerOrders[customerName] = 1;
            }
        });
        
        // Calculate package popularity for text display
        const packageCounts = {};
        bookings.forEach(booking => {
            if (packageCounts[booking.packageName]) {
                packageCounts[booking.packageName]++;
            } else {
                packageCounts[booking.packageName] = 1;
            }
        });
        
        // Display top customers (text version)
        const topCustomersContainer = document.getElementById('top-customers');
        if (topCustomersContainer) {
            let customersHTML = '';
            Object.entries(customerOrders)
                .sort(([,a], [,b]) => b - a) // Sort by order count descending
                .slice(0, 5) // Top 5 customers
                .forEach(([customerName, orderCount]) => {
                    customersHTML += `
                        <div class="customer-item">
                            <span class="customer-name">${customerName}</span>
                            <span class="customer-orders">${orderCount} orders</span>
                        </div>
                    `;
                });
            
            if (customersHTML === '') {
                customersHTML = '<p style="text-align: center; color: #7f8c8d;">No customer data available</p>';
            }
            
            topCustomersContainer.innerHTML = customersHTML;
        }
        
        // Display popular packages (text version)
        const popularPackagesContainer = document.getElementById('popular-packages');
        if (popularPackagesContainer) {
            let packagesHTML = '';
            Object.entries(packageCounts)
                .sort(([,a], [,b]) => b - a) // Sort by count descending
                .slice(0, 5) // Top 5 packages
                .forEach(([packageName, count]) => {
                    packagesHTML += `
                        <div class="package-item">
                            <span class="package-name">${packageName}</span>
                            <span class="package-count">${count} bookings</span>
                        </div>
                    `;
                });
            
            if (packagesHTML === '') {
                packagesHTML = '<p style="text-align: center; color: #7f8c8d;">No package data available</p>';
            }
            
            popularPackagesContainer.innerHTML = packagesHTML;
        }
        
        // Calculate top customers by revenue for charts
        const customerStats = {};
        bookings.forEach(booking => {
            const userProfile = userProfiles[booking.user?.email] || {};
            const customerName = userProfile.fullName || booking.user?.name || booking.user?.email || 'Unknown';
            
            if (!customerStats[customerName]) {
                customerStats[customerName] = { bookings: 0, totalSpent: 0 };
            }
            customerStats[customerName].bookings++;
            customerStats[customerName].totalSpent += booking.totalAmount;
        });
        
        // Sort by total spent
        const topCustomers = Object.entries(customerStats)
            .sort((a, b) => b[1].totalSpent - a[1].totalSpent)
            .slice(0, 5);
        
        // Calculate popular packages for charts
        const packageStats = {};
        bookings.forEach(booking => {
            const packageName = booking.packageName;
            if (!packageStats[packageName]) {
                packageStats[packageName] = 0;
            }
            packageStats[packageName]++;
        });
        
        const popularPackages = Object.entries(packageStats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        // Create charts
        createTopCustomersChart(topCustomers);
        createPopularPackagesChart(popularPackages);
    }
    
    // Function to create top customers chart
    function createTopCustomersChart(topCustomers) {
        const ctx = document.getElementById('topCustomersChart');
        if (!ctx) return;
        
        const labels = topCustomers.map(([name]) => name.length > 15 ? name.substring(0, 15) + '...' : name);
        const data = topCustomers.map(([, stats]) => stats.totalSpent);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Spent (RM)',
                    data: data,
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.8)',
                        'rgba(155, 89, 182, 0.8)',
                        'rgba(46, 204, 113, 0.8)',
                        'rgba(241, 196, 15, 0.8)',
                        'rgba(231, 76, 60, 0.8)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Total Spent (RM)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Customers'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Top Customers by Revenue'
                    }
                }
            }
        });
    }
    
    // Function to create popular packages chart
    function createPopularPackagesChart(popularPackages) {
        const ctx = document.getElementById('popularPackagesChart');
        if (!ctx) return;
        
        const labels = popularPackages.map(([name]) => name.length > 15 ? name.substring(0, 15) + '...' : name);
        const data = popularPackages.map(([, count]) => count);
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.8)',
                        'rgba(155, 89, 182, 0.8)',
                        'rgba(46, 204, 113, 0.8)',
                        'rgba(241, 196, 15, 0.8)',
                        'rgba(231, 76, 60, 0.8)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    title: {
                        display: true,
                        text: 'Popular Packages'
                    }
                }
            }
        });
    }
    
    // Function to load and display order history
    function loadOrderHistory() {
        loadAllOrders();
        loadPendingOrders();
        loadCompletedOrders();
        loadCancelledOrders();
    }
    
    // Function to load all orders (no action buttons)
    function loadAllOrders() {
        const orderTableBody = document.querySelector('#order-history-table tbody');
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        
        if (orderTableBody) {
            orderTableBody.innerHTML = '';
            
            if (bookings.length === 0) {
                orderTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No orders found.</td></tr>';
                return;
            }
            
            bookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt);
                const day = bookingDate.getDate().toString().padStart(2, '0');
                const month = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
                const year = bookingDate.getFullYear();
                const status = booking.status || 'Pending';
                
                // Reservation status logic
                let reservationStatus = '';
                if (booking.reservationStatusSummary) {
                    reservationStatus = booking.reservationStatusSummary;
                } else if (booking.reservationStatus && booking.reservationStatus.flight === 'Completed' && booking.reservationStatus.hotel === 'Completed') {
                    reservationStatus = '<span style="color:#27ae60;font-weight:600;">Completed</span>';
                } else if (booking.reservationStatus) {
                    reservationStatus = '<span style="color:#e74c3c;font-weight:600;">Not Completed</span>';
                } else {
                    reservationStatus = 'Not Started';
                }
                const reservationBtn = `<a href="reservation.html?orderId=${booking.id}" class="go-badge-btn">Go</a>`;
                const reservationCell = `<td style='vertical-align:middle;'>${reservationStatus} ${reservationBtn}</td>`;
                
                const statusClass = status === 'Completed' ? 'status-badge available' : 
                                  status === 'Cancelled' ? 'status-badge unavailable' : 
                                  'status-badge pending';
                
                // Get customer name from user profile if available
                const userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
                const userProfile = userProfiles[booking.user?.email] || {};
                const customerName = userProfile.fullName || booking.user?.name || booking.user?.email || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>BK${booking.id.toString().padStart(6, '0')}</td>
                    <td>${customerName}</td>
                    <td>${booking.packageName}</td>
                    <td>${day}/${month}/${year}</td>
                    <td><span class="${statusClass}">${status}</span></td>
                    ${reservationCell}
                `;
                orderTableBody.appendChild(row);
            });
        }
    }
    
    // Function to load pending orders
    function loadPendingOrders() {
        const pendingTableBody = document.querySelector('#pending-orders-table tbody');
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const pendingBookings = bookings.filter(booking => (booking.status || 'Pending') === 'Pending');
        
        if (pendingTableBody) {
            pendingTableBody.innerHTML = '';
            
            if (pendingBookings.length === 0) {
                pendingTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No pending orders found.</td></tr>';
                return;
            }
            
            pendingBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt);
                const day = bookingDate.getDate().toString().padStart(2, '0');
                const month = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
                const year = bookingDate.getFullYear();
                
                // Get customer name from user profile if available
                const userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
                const userProfile = userProfiles[booking.user?.email] || {};
                const customerName = userProfile.fullName || booking.user?.name || booking.user?.email || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>BK${booking.id.toString().padStart(6, '0')}</td>
                    <td>${customerName}</td>
                    <td>${booking.packageName}</td>
                    <td>${day}/${month}/${year}</td>
                    <td><span class="status-badge pending">Pending</span></td>
                    <td>
                        <button onclick="updateOrderStatus(${booking.id}, 'Completed')" class="edit-btn">Approve</button>
                        <button onclick="updateOrderStatus(${booking.id}, 'Cancelled')" class="delete-btn">Cancel</button>
                    </td>
                `;
                pendingTableBody.appendChild(row);
            });
        }
    }
    
    // Function to load completed orders
    function loadCompletedOrders() {
        const completedTableBody = document.querySelector('#completed-orders-table tbody');
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const completedBookings = bookings.filter(booking => booking.status === 'Completed');
        
        if (completedTableBody) {
            completedTableBody.innerHTML = '';
            
            if (completedBookings.length === 0) {
                completedTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No completed orders found.</td></tr>';
                return;
            }
            
            completedBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt);
                const day = bookingDate.getDate().toString().padStart(2, '0');
                const month = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
                const year = bookingDate.getFullYear();
                
                // Reservation status logic
                let reservationStatus = '';
                if (booking.reservationStatusSummary) {
                    reservationStatus = booking.reservationStatusSummary;
                } else if (booking.reservationStatus && booking.reservationStatus.flight === 'Completed' && booking.reservationStatus.hotel === 'Completed') {
                    reservationStatus = '<span style="color:#27ae60;font-weight:600;">Completed</span>';
                } else if (booking.reservationStatus) {
                    reservationStatus = '<span style="color:#e74c3c;font-weight:600;">Not Completed</span>';
                } else {
                    reservationStatus = 'Not Started';
                }
                const reservationBtn = `<a href="reservation.html?orderId=${booking.id}" class="go-badge-btn">Go</a>`;
                const reservationCell = `<td style='vertical-align:middle;'>${reservationStatus} ${reservationBtn}</td>`;
                
                // Get customer name from user profile if available
                const userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
                const userProfile = userProfiles[booking.user?.email] || {};
                const customerName = userProfile.fullName || booking.user?.name || booking.user?.email || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>BK${booking.id.toString().padStart(6, '0')}</td>
                    <td>${customerName}</td>
                    <td>${booking.packageName}</td>
                    <td>${day}/${month}/${year}</td>
                    <td><span class="status-badge available">Completed</span></td>
                    ${reservationCell}
                    <td>-</td>
                `;
                completedTableBody.appendChild(row);
            });
        }
    }
    
    // Function to load cancelled orders
    function loadCancelledOrders() {
        const cancelledTableBody = document.querySelector('#cancelled-orders-table tbody');
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const cancelledBookings = bookings.filter(booking => booking.status === 'Cancelled');
        
        if (cancelledTableBody) {
            cancelledTableBody.innerHTML = '';
            
            if (cancelledBookings.length === 0) {
                cancelledTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No cancelled orders found.</td></tr>';
                return;
            }
            
            cancelledBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt);
                const day = bookingDate.getDate().toString().padStart(2, '0');
                const month = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
                const year = bookingDate.getFullYear();
                
                // Reservation status logic
                let reservationStatus = '';
                if (booking.reservationStatusSummary) {
                    reservationStatus = booking.reservationStatusSummary;
                } else if (booking.reservationStatus && booking.reservationStatus.flight === 'Completed' && booking.reservationStatus.hotel === 'Completed') {
                    reservationStatus = '<span style="color:#27ae60;font-weight:600;">Completed</span>';
                } else if (booking.reservationStatus) {
                    reservationStatus = '<span style="color:#e74c3c;font-weight:600;">Not Completed</span>';
                } else {
                    reservationStatus = 'Not Started';
                }
                const reservationBtn = `<a href="reservation.html?orderId=${booking.id}" class="go-badge-btn">Go</a>`;
                const reservationCell = `<td style='vertical-align:middle;'>${reservationStatus} ${reservationBtn}</td>`;
                
                // Get customer name from user profile if available
                const userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
                const userProfile = userProfiles[booking.user?.email] || {};
                const customerName = userProfile.fullName || booking.user?.name || booking.user?.email || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>BK${booking.id.toString().padStart(6, '0')}</td>
                    <td>${customerName}</td>
                    <td>${booking.packageName}</td>
                    <td>${day}/${month}/${year}</td>
                    <td><span class="status-badge unavailable">Cancelled</span></td>
                    ${reservationCell}
                    <td>-</td>
                `;
                cancelledTableBody.appendChild(row);
            });
        }
    }
    
    // Function to update order status
    function updateOrderStatus(bookingId, newStatus) {
        if (confirm(`Are you sure you want to ${newStatus.toLowerCase()} this order?`)) {
            const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            const bookingIndex = bookings.findIndex(b => b.id === bookingId);
            
            if (bookingIndex !== -1) {
                bookings[bookingIndex].status = newStatus;
                localStorage.setItem('bookings', JSON.stringify(bookings));
                loadOrderHistory(); // This will refresh all tabs
                alert(`Order status updated to ${newStatus}!`);
            } else {
                alert('Order not found!');
            }
        }
    }
    </script>
    <script src="js/chat-widget.js"></script>
</body>
</html>